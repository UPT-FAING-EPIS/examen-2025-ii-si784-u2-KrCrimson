name: UI Tests with Video Recording

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  ui-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        browser: [chrome, firefox]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: Restore dependencies
      run: dotnet restore MusicPlayer.sln
      
    - name: Build solution
      run: dotnet build MusicPlayer.sln --configuration Release --no-restore
      
    - name: Setup Chrome
      if: matrix.browser == 'chrome'
      uses: browser-actions/setup-chrome@v1
      with:
        chrome-version: stable
        
    - name: Setup Firefox
      if: matrix.browser == 'firefox'
      uses: browser-actions/setup-firefox@v1
      with:
        firefox-version: latest
        
    - name: Install ffmpeg for video recording
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg xvfb
        
    - name: Start Xvfb
      run: |
        Xvfb :99 -screen 0 1920x1080x24 &
        echo "DISPLAY=:99" >> $GITHUB_ENV
        
    - name: Start Web Application
      run: |
        cd src/MusicPlayer.Web
        dotnet run --configuration Release --no-build &
        echo $! > webapp.pid
        sleep 10
      env:
        ASPNETCORE_URLS: http://localhost:5000
        
    - name: Wait for application to be ready
      run: |
        max_attempts=30
        attempt=0
        until curl -sf http://localhost:5000 > /dev/null || [ $attempt -eq $max_attempts ]; do
          echo "Waiting for application to start... (Attempt $((++attempt))/$max_attempts)"
          sleep 2
        done
        if [ $attempt -eq $max_attempts ]; then
          echo "Application failed to start"
          exit 1
        fi
        echo "Application is ready!"
        
    - name: Start video recording
      run: |
        mkdir -p ./videos
        ffmpeg -f x11grab -video_size 1920x1080 -i :99 -codec:v libx264 -r 12 ./videos/test-${{ matrix.browser }}.mp4 &
        echo $! > ffmpeg.pid
        
    - name: Run UI Tests
      run: |
        dotnet test tests/MusicPlayer.UITests/MusicPlayer.UITests.csproj \
          --configuration Release \
          --no-build \
          --verbosity normal \
          --logger "trx;LogFileName=test-results-${{ matrix.browser }}.trx"
      env:
        BROWSER: ${{ matrix.browser }}
        DISPLAY: :99
        
    - name: Stop video recording
      if: always()
      run: |
        if [ -f ffmpeg.pid ]; then
          kill $(cat ffmpeg.pid) || true
          sleep 2
        fi
        
    - name: Stop Web Application
      if: always()
      run: |
        if [ -f src/MusicPlayer.Web/webapp.pid ]; then
          kill $(cat src/MusicPlayer.Web/webapp.pid) || true
        fi
        
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ui-test-results-${{ matrix.browser }}
        path: |
          **/TestResults/**/*.trx
          
    - name: Upload video recording
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-video-${{ matrix.browser }}
        path: ./videos/*.mp4
        
  publish-results:
    needs: ui-tests
    runs-on: ubuntu-latest
    if: always() && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts
        
    - name: Create results page
      run: |
        mkdir -p ./ui-test-results
        cat > ./ui-test-results/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>UI Test Results - MusicPlayer</title>
            <style>
                body {
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    margin: 0;
                    padding: 20px;
                }
                .container {
                    max-width: 1200px;
                    margin: 0 auto;
                    background: white;
                    border-radius: 15px;
                    padding: 40px;
                    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
                }
                h1 {
                    color: #333;
                    text-align: center;
                    margin-bottom: 40px;
                }
                .browser-section {
                    margin: 30px 0;
                    padding: 20px;
                    background: #f8f9fa;
                    border-radius: 10px;
                }
                .browser-section h2 {
                    color: #667eea;
                    margin-top: 0;
                }
                video {
                    width: 100%;
                    max-width: 800px;
                    border-radius: 10px;
                    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                }
                .info {
                    background: #d1ecf1;
                    padding: 15px;
                    border-radius: 8px;
                    margin: 20px 0;
                    border-left: 4px solid #0c5460;
                }
                .timestamp {
                    color: #666;
                    font-size: 0.9em;
                    text-align: center;
                    margin-top: 40px;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>üéµ MusicPlayer UI Test Results</h1>
                
                <div class="info">
                    <strong>Test Run Information:</strong><br>
                    Date: $(date)<br>
                    Commit: ${{ github.sha }}<br>
                    Branch: ${{ github.ref_name }}
                </div>
                
                <div class="browser-section">
                    <h2>üåê Chrome Browser Tests</h2>
                    <video controls>
                        <source src="../test-video-chrome/test-chrome.mp4" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                </div>
                
                <div class="browser-section">
                    <h2>ü¶ä Firefox Browser Tests</h2>
                    <video controls>
                        <source src="../test-video-firefox/test-firefox.mp4" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                </div>
                
                <div class="timestamp">
                    Generated: $(date)
                </div>
            </div>
        </body>
        </html>
        EOF
        
    - name: Deploy UI Test Results to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./artifacts
        destination_dir: ui-tests
        keep_files: false
        
    - name: Deploy Results Page to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./ui-test-results
        destination_dir: ui-tests-report
        keep_files: false
